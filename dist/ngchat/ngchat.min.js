!function(){"use strict";angular.module("ngChatModule",["ngSanitize"]).config(["$httpProvider",function(a){a.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",a.defaults.dataType="json",a.defaults.transformRequest.unshift(function(a,b){var c,d=[];if("string"==typeof a)return a;for(c in a)a.hasOwnProperty(c)&&d.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return d.join("&")})}]).factory("utilityFactory",function(){return{replaceAll:function(a,b,c){return a.split(b).join(c)},takeFromRight:function(a,b){for(var c=[],d=a.length,e=d;e>0&&d-e!==b;e--)c.push(a[e-1]);return c.reverse()},guid:function(){var a=window.navigator,b=window.screen,c=a.mimeTypes.length;return c+=a.userAgent.replace(/\D+/g,""),c+=a.plugins.length,c+=b.pixelDepth||""},hashCode:function(a){if(!a)return"";for(var b=0,c=0;c<a.length;c++)b=a.charCodeAt(c)+((b<<5)-b);return b},intToHex:function(a){var b=(16777215&a).toString(16).toUpperCase();return"00000".substring(0,6-b.length)+b},insertTextAt:function(a,b){var c=document.querySelector(a);if(c){var d=c.scrollTop,e=0,f=c.selectionStart||"0"==c.selectionStart?"ff":!!document.selection&&"ie";if("ie"===f){c.focus();var g=document.selection.createRange();g.moveStart("character",-c.value.length),e=g.text.length}else"ff"===f&&(e=c.selectionStart);var h=c.value.length,i=c.value.substring(0,e),j=c.value.substring(e,h),k=/\s/,l=k.test(c.value.substring(e-1,e)),m=k.test(c.value.substring(e,e+1));if(i.length&&!l&&(i+=" "),j.length&&!m&&(j=" "+j),c.value=i+b+j,e+=b.length,i.length&&!l&&e++,j.length&&!m?e++:(c.value+=" ",e++),"ie"===f){c.focus();var n=document.selection.createRange();n.moveStart("character",-c.value.length),n.moveStart("character",e),n.moveEnd("character",0),n.select()}else"ff"===f&&(c.selectionStart=e,c.selectionEnd=e,c.focus());c.scrollTop=d,angular.element(c).triggerHandler("input")}}}}).factory("ngChatFactory",["$q","$http",function(a,b){return{getHistory:function(){return b.get("ngchat/server/read.php").then(function(b){return b.data?b.data:a.reject(b.data)},function(b){return a.reject(b.data)})},send:function(c){return b({method:"POST",url:"ngchat/server/send.php",data:c}).then(function(b){return b.data?b.data:a.reject(b.data)},function(b){return a.reject(b.data)})},status:function(c){return b({method:"POST",url:"ngchat/server/status.php",data:c}).then(function(b){return b.data?b.data:a.reject(b.data)},function(b){return a.reject(b.data)})}}}]).directive("focusOn",["$timeout",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.focusOn,function(b){b&&a(function(){c.focus()})})}}}]).directive("selectOn",["$window",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.selectOn,function(b){b&&(a.getSelection().toString()||c[0].setSelectionRange(0,c[0].value.length))})}}}]).directive("resetScrollOn",["$timeout",function(a){return function(b,c,d){b.$watch(d.resetScrollOn,function(b){b&&a(function(){c[0].scrollTop=c[0].scrollHeight})})}}]).directive("ngChatResizer",["$document","$timeout",function(a,b){return{restrict:"A",scope:{resizeTarget:"@"},link:function(b,c,d){function e(a){var b=a.pageY-i,c=h+b;g.css({height:c+"px"})}function f(){a.unbind("mousemove",e),a.unbind("mouseup",f)}var g,h=0,i=0;c.bind("mousedown",function(c){g=angular.element(document.querySelector(b.resizeTarget)),g&&(h=g[0].offsetHeight,i=c.pageY,a.bind("mousemove",e),a.bind("mouseup",f))})}}}]).directive("ngChatTooltip",["$document","$timeout",function(a,b){return{restrict:"A",scope:{ngChatTooltip:"@"},link:function(a,b,c){function d(a){if(e){var b=e[0].clientWidth,c=e[0].clientHeight,d=a.Y+Math.round(c),f=a.X-Math.round(b/2);e.css({top:d+"px",left:f+"px"})}}var e,f,g=!1;b.on("mouseenter",function(b){g||(f=angular.element(document).find("body"),f&&(g=!0,f.append('<div id="ng-chat-tooltip">'+a.ngChatTooltip+"</div>"),e=angular.element(document.querySelector("#ng-chat-tooltip")),d({X:b.pageX,Y:b.pageY}),e.addClass("visible")))}),b.on("mousemove",function(a){d({X:a.pageX,Y:a.pageY})}),b.on("mouseleave",function(){e&&e.remove(),e=null,g=!1})}}}]).constant("ngChatConfig",{minNameLength:4,maxNameLength:16,maxReplyLength:255,minAutoRefreshTime:5,maxAutoRefreshTime:300,minManualRefreshTime:3,shortDateFormat:"HH:mm:ss",fullDateFormat:"dd.mm.yyyy HH:mm:ss",smiliesEnabled:!0,smiliesDirectory:"ngchat/smilies/",smiliesFormat:".gif",smiliesList:[{code:"aa",emotions:["O:-)","O=)"]},{code:"ab",emotions:[":-)",":)","=)"]},{code:"ac",emotions:[":-(",":(",";("]},{code:"ad",emotions:[";-)",";)"]},{code:"ae",emotions:[":-P"]},{code:"af",emotions:["8-)"]},{code:"ag",emotions:[":-D"]},{code:"ah",emotions:[":-["]},{code:"ai",emotions:["*shock*","=-O"]},{code:"aj",emotions:[":-*"]},{code:"ak",emotions:[":'("]},{code:"al",emotions:[":-X",":-x"]},{code:"am",emotions:[">:o"]},{code:"an",emotions:[":-|"]},{code:"ao",emotions:[":-\\",":-/"]},{code:"ap",emotions:["*jokingly*"]},{code:"aq",emotions:["]:->","*devil*"]},{code:"ar",emotions:["[:-}"]},{code:"as",emotions:["*kissed*"]},{code:"at",emotions:[":-!"]},{code:"au",emotions:["*tired*"]},{code:"av",emotions:["*stop*"]},{code:"aw",emotions:["*kissing*"]},{code:"ax",emotions:["@}->--"]},{code:"ay",emotions:["*thumbsup*"]},{code:"az",emotions:["*drink*"]},{code:"ba",emotions:["*inlove*"]},{code:"bb",emotions:["@="]},{code:"bc",emotions:["*help*"]},{code:"bd",emotions:["\\m/"]},{code:"be",emotions:["%)"]},{code:"bf",emotions:["*ok*"]},{code:"bg",emotions:["*wassup*","*sup*"]},{code:"bh",emotions:["*sorry*"]},{code:"bi",emotions:["*clapping*"]},{code:"bj",emotions:["*rofl*","*lol*"]},{code:"bk",emotions:["*pardon*"]},{code:"bl",emotions:["*no*"]},{code:"bm",emotions:["*crazy*"]},{code:"bn",emotions:["*dontknow*"]},{code:"bo",emotions:["*dance*"]},{code:"bp",emotions:["*yahoo*"]},{code:"bq",emotions:["*hi*","*hello*"]},{code:"br",emotions:["*bye*"]},{code:"bs",emotions:["*yes*"]},{code:"bt",emotions:[";D","*acute*"]},{code:"bu",emotions:["*wall*","*dash*"]},{code:"bv",emotions:["*write*","*mail*"]},{code:"bw",emotions:["*scratch*"]}]}).directive("ngChat",function(){return{restrict:"E",templateUrl:"ngchat/ngchat.html",replace:!0,controller:["$scope","$document","$element","$interval","$timeout","$sce","ngChatConfig","ngChatFactory","utilityFactory",function(a,b,c,d,e,f,g,h,i){function j(b){if(!b||!b.length)return"";if(!a.smilies||!a.smilies.length)return b;for(var c,d,e=0,f=a.smilies.length;e<f;e++){c=a.smilies[e];for(var g=0,h=c.emotions.length;g<h;g++)d=c.emotions[g],b.toLowerCase().indexOf(d.toLowerCase())!=-1&&(b=i.replaceAll(b,d,'<img src="'+a.getSmileUrl(c.code)+'">'))}return b}function k(){if(a.history&&a.history.length)for(var b=0,c=a.history.length;b<c;b++)a.history[b].message=j(a.history[b].message)}function l(){var b=Math.floor(98*Math.random()+1);a.scrollReset=b}function m(){h.status({userId:a.guid()}).then(function(a){if(a&&a.length){w=[];for(var b=0,c=a.length;b<c;b++)w.push(a[b].userId)}})}function n(){a.refreshing=!0,h.getHistory().then(function(b){if(a.history.length){var c=a.history[a.history.length-1].messageId,d=b[b.length-1].messageId;if(c===d);else if(c<d){for(var e=d-c,f=i.takeFromRight(b,e),g=0,h=f.length;g<h;g++)f[g].message=j(f[g].message),a.history.push(f[g]);l()}}else a.history=b,k(),l()},function(){})["finally"](function(){a.initialized=!0,a.refreshing=!1})}function o(){a.refreshing||v&&new Date-v<=1e3*g.minManualRefreshTime||(v=new Date,m(),n())}function p(){u&&d.cancel(u),u=d(function(){o()},1e3*a.refreshTime)}function q(){a.error=""}function r(b){b&&(a.error=b,t&&e.cancel(t),t=e(function(){q()},5e3))}function s(){q(),h.send({userId:a.guid(),user:a.name,message:a.message.replace(/\r?\n/g,"<br>")}).then(function(b){"undefined"!=typeof b&&(b.message=j(b.message),a.history.push(b),l(),a.message="")},function(){r("Send message error")})["finally"](function(){})}a.shortDate=g.shortDateFormat,a.fullDate=g.fullDateFormat,a.smilies=g.smiliesEnabled?g.smiliesList:[],a.initialized=!1,a.refreshing=!1,a.name="",a.message="",a.history=[],a.error="";var t;a.scrollReset=0,a.refreshTimeMin=g.minAutoRefreshTime,a.refreshTime=g.minAutoRefreshTime;var u,v,w=[];a.options={detailed:!1,smilies:!1},a.guid=function(){return i.guid()},a.getUserBg=function(a){var b=i.hashCode(a.userId),c=i.intToHex(b);return"#"+c},a.isUserOnline=function(a){if(!a||!a.length)return!1;for(var b=0,c=w.length;b<c;b++)if(w[b]===a)return!0;return!1},a.getHtmContent=function(a){return a?f.trustAsHtml(a):""},a.isSmiliesEnabled=function(){return g.smiliesEnabled&&a.smilies&&a.smilies.length},a.getSmileUrl=function(a){return g.smiliesDirectory+a+g.smiliesFormat},a.insertText=function(a){i.insertTextAt("#chat-message",a)},a.quote=function(b,c){b===a.guid()},a.directRefresh=function(){o()},a.clear=function(){a.message=""},a.nameKeyPressed=function(b){a.name.length===g.maxNameLength&&b.preventDefault()},a.messageKeyPressed=function(b){10!=b.keyCode&&13!=b.keyCode||!b.ctrlKey||a.send(),a.message.length===g.maxReplyLength&&b.preventDefault()},a.send=function(){a.message&&a.message.trim().length&&a.name&&a.name.trim().length&&(s(),m())},a.$watch("name",function(b,c){c!=b&&b&&a.name.length>g.maxNameLength&&(a.name=a.name.substr(0,g.maxNameLength))}),a.$watch("message",function(b,c){c!=b&&b&&a.message.length>g.maxReplyLength&&(a.message=a.message.substr(0,g.maxReplyLength))}),a.$watch("refreshTime",function(b,c){if(void 0!==b&&isNaN(b))return void(a.refreshTime=c)}),a.refreshBlur=function(){a.refreshTime>=g.maxAutoRefreshTime?a.refreshTime=g.maxAutoRefreshTime:a.refreshTime<=g.minAutoRefreshTime&&(a.refreshTime=g.minAutoRefreshTime),p()},o(),p()}]}})}();