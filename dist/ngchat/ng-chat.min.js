!function(){"use strict";angular.module("ngChatModule",["ngSanitize"]).config(["$httpProvider",function(a){a.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",a.defaults.transformRequest.unshift(function(a,b){var c,d=[];if("string"==typeof a)return a;for(c in a)a.hasOwnProperty(c)&&d.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return d.join("&")})}]).factory("ngChatService",["$q","$http",function(a,b){return{getHistory:function(){return b.get("ngchat/read.php").then(function(b){return b.data?b.data:a.reject(b.data)},function(b){return a.reject(b.data)})},adminCommand:function(c){return b({method:"POST",url:"ngchat/admin.php",data:c,dataType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(b){return b.data?b.data:a.reject(b.data)},function(b){return a.reject(b.data)})},send:function(c){return b({method:"POST",url:"ngchat/send.php",data:c,dataType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(b){return b.data?b.data:a.reject(b.data)},function(b){return a.reject(b.data)})},status:function(c){return b({method:"POST",url:"ngchat/status.php",data:c,dataType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(b){return b.data?b.data:a.reject(b.data)},function(b){return a.reject(b.data)})}}}]).directive("ngChatInputFocus",function(){return{restrict:"A",link:function(a,b){var c;b.on("click",function(){c!=this&&(this.select(),c=this)}),b.on("blur",function(){c=null})}}}).directive("ngChat",function(){return{restrict:"E",templateUrl:"ngchat/ng-chat.html",replace:!0,controller:["$scope","$element","$interval","$timeout","$sce","ngChatService",function(a,b,c,d,e,f){function g(a){for(var b=0,c=0;c<a.length;c++)b=a.charCodeAt(c)+((b<<5)-b);return b}function h(a){var b=(16777215&a).toString(16).toUpperCase();return"00000".substring(0,6-b.length)+b}function i(a){return a=a.substring(1),a=parseInt(a,16),a=16777215^a,a=a.toString(16),a=("000000"+a).slice(-6),a="#"+a}function j(b){return _.forEach(a.smilies,function(c){_.forEach(c.emotions,function(d){if(b.toLowerCase().indexOf(d.toLowerCase())!=-1){var e='<img src="'+a.getSmileUrl(c.code)+'" alt="'+d+'" />';b=b.replaceAll(d,e)}})}),b}function k(){a.history&&a.history.length&&_.forEach(a.history,function(a){a.message=j(a.message)})}function l(){var a=$(w);a&&d(function(){a.scrollTop(a[0].scrollHeight)},50)}function m(){f.adminCommand({userId:a.guid(),action:"GET",args:{}}).then(function(a){z=a})}function n(){f.status({userId:a.guid()}).then(function(a){a&&a.length&&(y=_.map(a,function(a){return a.userId}))},function(){console.log("ngChatService.status() error")})}function o(){a.refreshing||(console.log("refresh() started"),a.refreshing=!0,n(),f.getHistory().then(function(b){if(console.log("ngChatService.getHistory(): "+(b?b.length:0)),a.history.length){var c=_.last(a.history).messageId,d=_.last(b).messageId;if(c==d)console.log("last message is the same... do nothing");else if(c<d){var e=d-c;console.log("count of newer: "+e),_.forEach(_.takeRight(b,e),function(b){b.message=j(b.message),a.history.push(b)}),l()}console.log("refresh() ended")}else console.log("first load"),a.history=b,k(),l(),console.log("refresh() ended")},function(a){console.log("ngChatService.getHistory() error")})["finally"](function(){a.refreshing=!1,a.initialized=!0}))}String.prototype.replaceAll=function(a,b){return this.split(a).join(b)},jQuery.fn.getSelectionStart=function(){var a,b,c;return 0==this.lengh?-1:(a=this[0],b=a.value.length,a.createTextRange?(c=document.selection.createRange().duplicate(),c.moveEnd("character",a.value.length),b=""==c.text?a.value.length:a.value.lastIndexOf(c.text)):"undefined"!=typeof a.selectionStart&&(b=a.selectionStart),b)},jQuery.fn.getCursorPosition=function(){return 0==this.lengh?-1:$(this).getSelectionStart()};var p=16,q=255,r=5,s=300;a.dateFormat="dd.mm.yyyy HH:mm:ss";var t="ngchat/smilies/",u=".gif",v=".ng-chat-resizer",w=".ng-chat-history";a.smilies=[{code:"aa",emotions:["O:-)","O=)"]},{code:"ab",emotions:[":-)",":)","=)"]},{code:"ac",emotions:[":-(",":(",";("]},{code:"ad",emotions:[";-)",";)"]},{code:"ae",emotions:[":-P"]},{code:"af",emotions:["8-)"]},{code:"ag",emotions:[":-D"]},{code:"ah",emotions:[":-["]},{code:"ai",emotions:["*shock*","=-O"]},{code:"aj",emotions:[":-*"]},{code:"ak",emotions:[":'("]},{code:"al",emotions:[":-X",":-x"]},{code:"am",emotions:[">:o"]},{code:"an",emotions:[":-|"]},{code:"ao",emotions:[":-\\",":-/"]},{code:"ap",emotions:["*jokingly*"]},{code:"aq",emotions:["]:->","*devil*"]},{code:"ar",emotions:["[:-}"]},{code:"as",emotions:["*kissed*"]},{code:"at",emotions:[":-!"]},{code:"au",emotions:["*tired*"]},{code:"av",emotions:["*stop*"]},{code:"aw",emotions:["*kissing*"]},{code:"ax",emotions:["@}->--"]},{code:"ay",emotions:["*thumbsup*"]},{code:"az",emotions:["*drink*"]},{code:"ba",emotions:["*inlove*"]},{code:"bb",emotions:["@="]},{code:"bc",emotions:["*help*"]},{code:"bd",emotions:["\\m/"]},{code:"be",emotions:["%)"]},{code:"bf",emotions:["*ok*"]},{code:"bg",emotions:["*wassup*","*sup*"]},{code:"bh",emotions:["*sorry*"]},{code:"bi",emotions:["*clapping*"]},{code:"bj",emotions:["*rofl*","*lol*"]},{code:"bk",emotions:["*pardon*"]},{code:"bl",emotions:["*no*"]},{code:"bm",emotions:["*crazy*"]},{code:"bn",emotions:["*dontknow*"]},{code:"bo",emotions:["*dance*"]},{code:"bp",emotions:["*yahoo*"]},{code:"bq",emotions:["*hi*","*hello*"]},{code:"br",emotions:["*bye*"]},{code:"bs",emotions:["*yes*"]},{code:"bt",emotions:[";D","*acute*"]},{code:"bu",emotions:["*wall*","*dash*"]},{code:"bv",emotions:["*write*","*mail*"]},{code:"bw",emotions:["*scratch*"]}],a.initialized=!1,a.refreshing=!1,a.name="",a.reply="",a.history=[],a.refreshTime=2*r;var x,y=[],z=[];a.guid=function(){var a=window.navigator,b=window.screen,c=a.mimeTypes.length;return c+=a.userAgent.replace(/\D+/g,""),c+=a.plugins.length,c+=b.height||"",c+=b.width||"",c+=b.pixelDepth||""},a.getUserBg=function(a){return a.toggle?"#"+h(g(a.userId)):""},a.getUserColor=function(b){return b.toggle?i(a.getUserBg(b.userId)):""},a.isUserOnline=function(a){return!(!a||!a.length)&&_.some(y,function(b){return b===a})},a.isUserAdmin=function(){return!(!z||!z.length)&&_.some(z,function(b){return b===a.guid()})},a.getHtmContent=function(a){return a?e.trustAsHtml(a):""},a.getSmileUrl=function(a){return t+a+u},a.refreshTimeChanged=function(){a.refreshTime>s&&(a.refreshTime=s),a.refreshTime<r&&(a.refreshTime=r)},a.insertText=function(b){var c=$("#idreply").getCursorPosition();a.reply.trim().length||(b=" "+b),a.reply=[a.reply.slice(0,c),b,a.reply.slice(c)].join("")},a.quote=function(b,c){b===a.guid()||a.reply.trim().length||(a.reply=c+", "+a.reply)},a.adminDelete=function(b){var c=confirm("Are you sure would like to remove this message?");1==c&&f.adminCommand({userId:a.guid(),action:"DELETE",args:{historyObject:b}}).then(function(c){console.log("ngChatService.adminCommand():"),console.log(c),_.remove(a.history,function(a){return a.messageId==b.messageId})},function(a){console.log("ngChatService.adminCommand() error")})},a.tempEditFocusOut=function(a){if(a.edited===a.message)a.isEditing=!1;else if(a.isEditing&&a.edited.trim().length){var b=confirm("Would you like to edit this message?");1==b&&(a.message=angular.copy(a.edited)),a.isEditing=!1}},a.adminEdit=function(b){b.edited=angular.copy(b.message),b.isEditing?a.tempEditFocusOut(b):b.isEditing=!0},a.toggleDetails=function(a){a.toggle=!a.toggle},a.directRefresh=function(){o()},x=c(function(){o()},1e3*a.refreshTime),a.clear=function(){a.reply&&a.reply.length&&(a.reply="")},a.nameKeyPress=function(b){a.name.length==p&&b.preventDefault()},a.replyKeyPress=function(b){a.reply.length==q&&b.preventDefault()},a.send=function(){n(),f.send({userId:a.guid(),user:a.name,message:a.reply}).then(function(b){console.log("ngChatService.send()"),console.log(b),"undefined"!=typeof b&&(b.message=j(b.message),a.history.push(b),l()),a.reply=""},function(a){console.log("ngChatService.send() error"),console.log(a)})["finally"](function(){})},angular.element(document).ready(function(){$(v).on("mousedown",function(a){var b=$(w),c=b.height(),d=a.pageY;$(document).on("mouseup",function(a){$(document).off("mouseup").off("mousemove")}),$(document).on("mousemove",function(a){var e=a.pageY-d,f=c+e;b.css({height:f})})})}),a.$watch("name",function(b,c){c!=b&&b&&a.name.length>p&&(a.name=a.name.substr(0,p))}),a.$watch("reply",function(b,c){c!=b&&b&&a.reply.length>q&&(a.reply=a.reply.substr(0,q))}),o(),d(function(){m()},100)}]}})}();